## IPv4 復習

### 0. 目的

- IPv6 との対比が必要なポイントをおさえる
- AWS ではほぼ意識しない IPv4 の仕組みをおさえる
- IPv4 全般の復習でない点に注意する
  - 理解が足りない部分は各自で補う

### 1. IPv4 アドレス

#### アドレスの構成

- 全 32 ビット
  - 8 ビットずつ「.」で区切って十進表記の数字を 4 つ並べる
    - 例 : https://www.infraexpert.com/studygif/ip9.gif
  - ネットワークを識別する部分（ネットワーク部）と、ネットワーク内のホストを識別する部分（ホスト部）に分かれる
    - ネットワーク部とホスト部を分けるための概念にはクラスフルとクラスレスがあり、現在は基本的にクラスレスが使われる
    - クラスレスのアドレス表記では、アドレスの後に「/」で区切ってネットワーク部のビット長（プレフィックス長）を記す
- 各ネットワーク（サブネット）の最初のアドレス（ホスト部の全ビットが「0」）をネットワークアドレス、最後のアドレス（同「1」）をブロードキャストアドレスと呼ぶ
  - 例 :
    - 192.168.0.0/24 のネットワークでは、192.168.0.0 がネットワークアドレス、192.168.0.255 がブロードキャストアドレス
    - 192.168.1.0/30 のネットワークでは、192.168.1.0 がネットワークアドレス、192.168.1.3 がブロードキャストアドレス
  - これらは個別のホスト（ノード）に割り当てることはできない（予約済みアドレス）

#### アドレスの種類 (1) プライベート・グローバル・その他

- プライベートアドレス : 組織内で自由に割り当てて使うアドレス
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 192.168.0.0/16
- リンクローカルアドレス : 固定アドレスを持たず、DHCP（後述）でアドレスが自動取得できない場合にランダムに割り当てられるアドレス
  - 169.254.0.0/16
    - APIPA（Automatic Private IP Addressing : IP アドレス自己割り当て）による
    - 直接到達可能なネットワーク内にあるホスト同士で通信するために存在
    - AWS の VPC では別の目的に使用されている（IMDS や DNS のリゾルバなど）
- マルチキャストアドレス : 単一のホストではなく複数のホストに同時に送信するためのアドレス（宛先専用）
  - 224.0.0.0/4
    - マルチキャストアドレスにもプライベート・リンクローカル・グローバルの区別がある（説明は省略）
- ループバックアドレス : ホスト自身への通信に使用するアドレス（予約済みアドレス）
  - 127.0.0.0/8
    - 基本的には 127.0.0.1 を使うことが多い
- グローバルアドレス : インターネット通信用アドレス（パブリックアドレス）
  - 上記以外のアドレス範囲
    - ICANN が管理しているアドレスを各地域の NIC 経由で各組織に割り当て
      - 参考 : https://www.nic.ad.jp/ja/ip/admin-basic.html
    - 実際には組織に割り当てずに特定目的用に予約されているアドレス範囲もある（例：192.0.2.0/24 などの例示用アドレス）

#### アドレスの種類 (2) ユニキャスト・マルチキャスト・ブロードキャスト

- ユニキャストアドレス : 単一のホスト宛てのアドレス
  - 実際には、同じアドレス体系（見た目には区別がつかない）で IP anycast を使って、離れた場所にある複数のホストに通信するケースもある
    - 例 :
      - ルート DNS（一部を除く）
        - https://jprs.jp/related-info/guide/topics-column/no5.html
      - TLD などの上位の権威 DNS
- マルチキャストアドレス : (1) で説明（宛先専用）
- ブロードキャストアドレス : 複数のホストあてのアドレス
  - 限定（リミテッド）ブロードキャストアドレス : 255.255.255.255
    - 同一ネットワーク（サブネット）内の全てのホスト宛て・ルータ越えはしない
  - ディレクテッド（ダイレクト）ブロードキャストアドレス : 宛先ネットワークのブロードキャストアドレス（ホスト部の全ビットが「1」）
    - 別名「ネットワークブロードキャストアドレス」
    - 送信元と同じネットワークに対するブロードキャストアドレスの場合は「ローカルブロードキャストアドレス」と呼ぶ（使われ方は限定ブロードキャストアドレスと同じ）
    - 別のネットワークに対するブロードキャストアドレスの場合、実際にネットワーク（サブネット）をまたいで送信可能かは経由するルータの設定による
  - AWS の VPC ではブロードキャストはサポートされないので、アドレスだけが予約されている
    - https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/subnet-sizing.html#subnet-sizing-ipv4

#### アドレスの割り当て方法

- 固定アドレス割り当て : ホスト側で固定的に指定
  - この場合、デフォルトゲートウェイ（ルーティングテーブルに経路情報が存在しない宛先に転送するためのルータのアドレス）や DNS リゾルバのアドレスなども固定的に指定する
- DHCP(v4) による割り当て : DHCP サーバーから割り当ててもらう
  - 参考 : https://www.infraexpert.com/study/tcpip13.html
  - 1. ホストは UDP 67 宛て（送信元 UDP 68）で同一ネットワーク内にブロードキャストして（限定ブロードキャストアドレスを宛先にする）DHCP サーバーの反応を待つ（DHCP Discover）
  - 2. DHCP サーバーは UDP 67 を受け取ったら割り当て候補のアドレスを UDP 68 宛てでホストに返す（DHCP Offer）
  - 3. ホストは最初に UDP 68 で受け取ったアドレスを採用して、そのことをネットワーク内にブロードキャスト（DHCP Request）
  - 4. Offer したアドレスが採用された DHCP サーバーは、デフォルトゲートウェイなどを含むアドレス設定情報を UDP 68 宛てでホストに返す（DHCP Ack）
  - 5. ホストはデフォルトゲートウェイなどを含めてアドレスを設定する
  - DHCP サーバーが別ネットワークに存在する場合は、ルータが持つ DHCP リレーエージェント機能を介してホストとの間のやりとりを行う
  - DHCP サーバーは特定のホスト（MAC アドレスで識別）からの Discover を受けると特定の IP アドレスを Offer する機能を持つ（リース予約）
    - EC2 のプライベートアドレスを固定する場合、EC2（EBS）内の設定ファイルなどに直接記述するのではなく、DHCP サーバーがリース予約で割り当てる
  - AWS の VPC はブロードキャストをサポートしておらず、DHCP サーバーの所在も隠蔽されているため、独自の通信方法または処理方法を取っている可能性が高い
    - VPC の各サブネットには DHCP サーバーの IP アドレスは予約されていない
      - 参考 : https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/subnet-sizing.html#subnet-sizing-ipv4
- APIPA による割り当て : (1) で説明
- これらのどのケースでも、1 つのネットワークインターフェースには 1 つのアドレスしか割り当てできない
  - 1 つの物理ネットワークインターフェースに複数のアドレスを割り当てるには、仮想ネットワークインターフェースを設定する必要がある
- AWS の VPC は以下の点でやや特殊
  - 前述のとおりブロードキャストをサポートしていない
  - リンクローカルアドレスがホストのネットワークインターフェースに直接割り当てられることなく、IMDS や DNS のリゾルバなどへの通信に使われている
    - NACL やセキュリティグループでは特に意識しなくても通信可能になっている
  - パブリックサブネットの場合、プライベートアドレスとグローバル（パブリック）アドレスが同じネットワークインターフェースに対して同時に割り当てられているかのように見える
    - 実際には 1:1 の NAT でインターネットゲートウェイを通過する際にアドレス変換が行われている
      - Elastic IP がアタッチされていると変換先のグローバル（パブリック）アドレスが固定になる

### 2. ホスト間通信の方法

#### 同一ネットワーク内 : ARP を使って相手の MAC アドレスを割り出して通信する

- ARP を使って相手の MAC アドレスを識別して通信する
  - 参考 : https://www.infraexpert.com/study/tcpip2.html
  - ホストは、自身が持つ ARP テーブルで宛先の IPv4 アドレスを検索する
    - a. 宛先の IPv4 アドレスが ARP テーブルに存在した場合、ARP テーブルを見て相手の MAC アドレスを割り出す 
    - b. 宛先の IPv4 アドレスが ARP テーブルに存在しなかった場合、「このアドレスを持つホストは誰？」の問い合わせを同一ネットワーク内にブロードキャストする
      - b-2. ブロードキャストを受け取ったホストは、自分がそのアドレスを持っている場合にのみ応答する
      - b-3. 応答を受けた送信元ホストは、IPv4 アドレスと応答の MAC アドレス、残存期間を ARP テーブルに保存する
        - 参考 : https://www.infraexpert.com/study/tcpip3.html
- AWS の VPC ではブロードキャストをサポートしていない（ことになっている）が、パケットをキャプチャしてみると ARP パケットは流れている
  - 何らかの方法で ARP のブロードキャストをエミュレーションしている模様？

#### 別ネットワーク間 : ルートテーブルを使ってルータに中継を依頼する

- 参考 : https://www.infraexpert.com/study/routing.html#google_vignette
- 1. ホストは、ルートテーブルを使って中継先のルータを選ぶ
  - 1-1-a. ホスト自身が持つルートテーブルに宛先のネットワークが存在する場合は、ネクストホップの IPv4 アドレス（ルータ）宛てに通信して中継してもらう
  - 1-1-b. ホスト自身が持つルートテーブルに宛先のネットワークが存在しない場合は、デフォルトゲートウェイの IPv4 アドレス（ルータ）宛てに通信して中継してもらう
  - 1-2. 中継先ルータの IPv4 アドレスが ARP テーブルに存在しない場合は「同一ネットワーク内」で説明したとおりの方法で MAC アドレスを割り出す
- 2. 中継先ルータは、宛先または次の中継先を見つけて転送する
  - 2-a. 中継先ルータ自身が直接接続している IPv4 ネットワークが宛先の場合は、対象ホスト宛てに通信する
  - 2-b. 中継先ルータ自身が直接接続していない IPv4 ネットワークが宛先の場合は、中継先ルータのルートテーブルでルートを検索して見つけたネクストホップの IPv4 アドレス（ルータ）宛てに通信してさらに中継してもらう
    - 2-b-2. 中継先ルータ自身のルートテーブルにない IPv4 ネットワークが宛先の場合は、中継先ルータのデフォルトゲートウェイの IPv4 アドレス（ルータ）宛てに通信してさらに中継してもらう
- 3. 宛先から送信元への応答（戻り）も同じ流れで経路を選んで通信する

#### 複数のネットワークを経由して通信（インターネット通信）する際の注意点 : Path MTU Discovery Blackhole 問題

- それぞれのネットワーク（ルータ）が直接扱うことができるパケットの最大長（MTU）が異なるケースがある
  - 例えば、日本で NTT 系のフレッツ光などの回線を使う場合、PPPoE 接続を使うとイーサネット上で IPv4 パケットをカプセル化する際のヘッダが必要になるため、PPPoE で転送可能なパケットはその分最大長が短くなる
- そのようなパケットをルータが転送する際は、パケットを複数に分割して（次の）宛先に送信する
  - 図 : https://milestone-of-se.nesuke.com/wp-content/uploads/2016/12/pmtud-01v2.png.webp
- ところが、IPv4 パケットのヘッダで DF（フラグメント禁止）ビットが立っていると、そのパケットは分割転送できない
- 分割禁止の場合、ルータは送信元に対して「最大パケット長は◯◯まで」という情報を ICMP（Type 3 / 4）を使って伝える
  - 送信元は指定に合わせてパケットサイズを短くして再送する
- ここでファイアーウォールやパケットフィルタなどで ICMP をいたずらに遮断してしまうと、「最大パケット長は◯◯まで」という情報も伝わらず、通信が成立しない
  - 図 : https://milestone-of-se.nesuke.com/wp-content/uploads/2016/12/black-hole-01.png.webp
- Packetization Layer Path MTU Discovery という方法での回避が提案された
  - 図 : https://milestone-of-se.nesuke.com/wp-content/uploads/2019/12/plpmtud-02.png.webp
  - QUIC / HTTP/3 での利用のため、UDP に適用する Datagram Packetization Layer Path MTU Discovery が検討されている

#### プライベートアドレス空間からインターネットにアクセスする方法

- NAT 技術を使う
  - 大きく分けて「1:1 の NAT」と「n（多）:1 の NAT」がある
  - 1:1 の NAT では、プライベートアドレスをグローバル（パブリック）アドレスに 1:1 で変換して通信する
    - この方法では、プライベートアドレスを持つホストからインターネットへのアクセスだけでなく、インターネットからプライベートアドレスを持つホストへのアクセスも（ファイアーウォールやパケットフィルタなどでそのように設定すれば）可能
      - AWS で Elastic IP をアタッチするとこの状態になる
      - アドレスとポート番号を 1:1 で変換する機能を「ポートフォワーディング」という
        - 例 : 172.16.0.200:8080 で待ち受けしているサーバーを、インターネット上に 192.168.2.200:80 で公開するようなときに使う
  - n（多）:1 の NAT では、複数のプライベートアドレスをもつホストを 1 つのグローバル（パブリック）アドレスに変換して通信する
    - 複数の送信元ポート番号に変換することで n（多）:1 を実現している
      - 戻りパケットの宛先ポート番号で、どのプライベートアドレスを持つホストへの応答かを判別
    - アドレスと同時にポート番号も変換するため NAPT と呼ぶ
      - AWS の VPC では NAT 動作を隠蔽している（直接 EC2 にパブリックアドレスが割り当てられているかのように見せている）一方、NAPT のことを NAT と表現している
        - 例 : NAT ゲートウェイ

### 3. DNS レコード

#### IPv4 専用

- A レコード : 正引き用レコード
  - 例 : www.example.co.jp → 192.0.2.100
  - AWS の場合、動的にアドレスが変わるマネージドサービス（ALB など）の正引きを CNAME を使わずに実現するためのエイリアス機能がある

#### IPv4・IPv6 兼用

- その他については基本的に兼用
  - 例 :
    - PTR レコード : 逆引き用レコード
      - 例 : 192.0.2.100 → www.example.co.jp
    - CNAME レコード : ドメインまたはサブドメインに対する別名用レコード
      - 例 : db1.example.co.jp → dbserver1.example.com
      - CNAME で別名を引いた後、さらに A レコード（↑の例では dbserver1.example.com）に対する正引きが必要になるため、名前解決が 2 段階になる
    - MX レコード : メールサーバー（SMTP）用レコード
    - NS レコード : ネームサーバー用レコード
    - TXT レコード : テキストを設定するレコード
      - 利用例 :
        - SPF
        - DKIM
